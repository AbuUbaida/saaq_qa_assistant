services:
  weaviate:
    command:
    - --host
    - 0.0.0.0
    - --port
    - '8080'
    - --scheme
    - http
    image: cr.weaviate.io/semitechnologies/weaviate:1.34.0
    # ports:
    # - 8080:8080
    # - 50051:50051
    restart: unless-stopped
    volumes:
    - weaviate_data:/var/lib/weaviate
    environment:
      QUERY_DEFAULTS_LIMIT: 25
      AUTHENTICATION_ANONYMOUS_ACCESS_ENABLED: 'true'
      PERSISTENCE_DATA_PATH: '/var/lib/weaviate'
      ENABLE_API_BASED_MODULES: 'true'
      BACKUP_FILESYSTEM_PATH: '/var/lib/weaviate/backups'
      CLUSTER_HOSTNAME: 'node1'
      AUTOSCHEMA_ENABLED: 'false'
    mem_limit: 256m
    mem_reservation: 128m
    cpus: 0.5

  backend:
    build:
      context: .
      dockerfile: backend/Dockerfile
    environment:
      WEAVIATE_USE_LOCAL: "true"
      WEAVIATE_HOST: "weaviate"
      WEAVIATE_PORT: "8080"
      HF_API_KEY: ${HF_API_KEY:-}
      CORS_ALLOW_ORIGINS: "*"
      OTEL_ENABLED: "true"
      OTEL_SERVICE_NAME: "saaq-qa-assistant"
      OTEL_EXPORTER_OTLP_ENDPOINT: "http://otel-collector:4317"
    # ports:
    #   - "8000:8000"
    depends_on:
      - weaviate
    restart: unless-stopped
    volumes:
      - ./scripts:/app/scripts:ro
      - ./data:/app/data:ro
    mem_limit: 512m
    mem_reservation: 256m
    cpus: 0.5

  frontend:
    build:
      context: .
      dockerfile: frontend/Dockerfile
    environment:
      BACKEND_BASE_URL: "http://backend:8000"
      REQUEST_TIMEOUT: 120
    # ports:
    #   - "8501:8501"
    depends_on:
      - backend
    restart: unless-stopped
    mem_limit: 256m
    mem_reservation: 128m
    cpus: 0.5

  nginx:
    image: nginx:1.27-alpine
    ports:
      - "80:80"
    volumes:
      - ./infra/nginx.conf:/etc/nginx/conf.d/default.conf:ro
    depends_on:
      - frontend
      - backend
    restart: unless-stopped
    mem_limit: 64m
    mem_reservation: 32m
    cpus: 0.25

  otel-collector:
    image: otel/opentelemetry-collector
    command: ["--config=/etc/otel-collector.yml"]
    volumes:
      - ./infra/otel-collector.yml:/etc/otel-collector.yml:ro
    restart: unless-stopped
    mem_limit: 128m
    mem_reservation: 64m
    cpus: 0.25

  phoenix:
    image: arizephoenix/phoenix:latest
    # ports:
    #   - "6006:6006"
    environment:
      PHOENIX_PORT: "6006"
      PHOENIX_HOST_ROOT_PATH: "/phoenix"
    restart: unless-stopped
    volumes:
      - phoenix_data:/app/data
    mem_limit: 256m
    mem_reservation: 128m
    cpus: 0.5

volumes:
  weaviate_data:
  phoenix_data:

